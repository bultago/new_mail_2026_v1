<?xml version="1.0" encoding="UTF-8" ?>

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.terracetech.tims.webmail.MailUser.mapper.MailUserMapper">
	<sql id="userAuthInfoSql">
		SELECT 
			m.mail_user_seq, m.mail_uid, m.mail_domain_seq, m.mail_group_seq, 
			m.mail_password, m.mail_host, m.message_store, m.account_expire_date, 
			m.account_status, m.user_type, m.mail_services, m.mail_add_quota, 
			m.quota_overlook_ratio, m.quota_warning_mode, m.quota_warning_ratio, m.quota_violation_action, 
			
			i.user_name, i.user_language, i.web_folder_add_quota, i.big_attach_add_quota, 
			i.last_login_time, i.webmail_login_time, i.pop_login_time, i.imap_login_time,
			i.register_status,
			
			e.page_line_cnt, e.sender_name, e.save_send_box, e.receive_noti, 
			e.vcard_attach, e.user_locale, e.write_mode, e.char_set, 
			e.hidden_img, e.sign_attach, e.after_login, e.hidden_tag, 
			e.noti_interval, e.user_skin, e.forwarding_mode, e.sender_email, 
			e.auto_save_mode, e.auto_save_term, i.last_pass_modify_time,i.create_time,
			
			d.mail_domain
		FROM 
			mail_user m, mail_user_info i, wcf_userinfoetc e, mail_domain d
	</sql>
	
	<sql id="userConnectionInfoSql">
		SELECT 
			m.mail_user_seq, m.mail_uid, m.mail_domain_seq, m.mail_group_seq, 
			m.mail_password, m.mail_host, m.message_store, m.account_expire_date, 
			m.account_status, m.user_type, m.mail_services, m.mail_add_quota, 
			m.quota_overlook_ratio, m.quota_warning_mode, m.quota_warning_ratio, m.quota_violation_action, 
			
			i.user_name, i.user_language, i.web_folder_add_quota, i.big_attach_add_quota, 
			i.last_login_time, i.webmail_login_time, i.pop_login_time, i.imap_login_time,
			i.register_status,
						
			d.mail_domain
		FROM 
			mail_user m, mail_user_info i, mail_domain d
	</sql>
	
	<sql id="searchCondSql">
		<dynamic prepend=" " >
			<isNotNull property="seqKey">
				<isGreaterThan property="seqNumber" compareValue="0" prepend="AND">
					${seqKey} = #{seqNumber}
				</isGreaterThan>
			</isNotNull>
			<isNotNull property="compareValue" prepend="AND">
				<isEqual property="likeUsed" compareValue="true"> 
					${searchKey} like #{sqlCompareValueStr}
				</isEqual>
				<isEqual property="likeUsed" compareValue="false">
					${searchKey} = #{compareValue}
				</isEqual>
			</isNotNull>
			<isNotNull property="sortKey" prepend=" ">
				 ORDER BY ${sortKey} 
				<isEqual property="descending" compareValue="true">
					DESC
				</isEqual>
			</isNotNull>
		</dynamic>
	</sql>
	
	<sql id="simpleUserInfoSql" >
		SELECT 
			m.mail_user_seq, m.mail_uid mail_uid, m.mail_domain_seq mail_domain_seq, 
			d.mail_domain, i.user_name user_name
		FROM 
			mail_user m, mail_user_info i, mail_domain d 
		WHERE 
			m.mail_domain_seq = d.mail_domain_seq
			AND m.mail_user_seq = i.mail_user_seq
	</sql>
	
	<select id="searchSimpleUserInfoList" parameterType="searchVO" resultMap="userListResult">
		<include refid="simpleUserInfoSql"/>
		AND m.mail_uid not in ('tims_bbs_storage_user', 'tims_webfolder_storage_user', 'hamadm', 'spamadm', 'mailadm')
		
		AND
		<include refid="searchCondSql"/>
		
		limit #{skipResult}, #{maxResult}
	</select>
	
	<select id="getLastRcptCount" resultType="int" parameterType="Map" cacheModel="lastRcptCache">
    	SELECT
      		count(mail_user_seq)
    	FROM wcf_lastrcpt
    	WHERE 
    		mail_user_seq=#{userSeq}
    		and lastrcpt_email = #{email}
  	</select>
	
	<select id="getLastRcpt" resultMap="lastRcptResult" parameterType="int" cacheModel="lastRcptCache">
    	SELECT
      		mail_user_seq, lastrcpt_email, lastrcpt_personnel, case when rcpt_seq is null then 0 else rcpt_seq end as rcpt_seq
    	FROM wcf_lastrcpt
    	WHERE 
    		mail_user_seq=#{value}
    	order by rcpt_seq desc
  	</select>
  	
  	<select id="getLastRcptByMaxRcptCount" resultMap="lastRcptResult" parameterType="Map" cacheModel="lastRcptCache">
    	SELECT
      		mail_user_seq, lastrcpt_email, lastrcpt_personnel, case when rcpt_seq is null then 0 else rcpt_seq end as rcpt_seq
    	FROM wcf_lastrcpt
    	WHERE 
    		mail_user_seq=#{mailUserSeq}
    	order by rcpt_seq desc
    	limit 0, #{maxRcptCount}
  	</select>
  	
  	<delete id="deleteLastRcpt" parameterType="int" >
		delete from wcf_lastrcpt where mail_user_seq = #{value}
	</delete>
	
	<delete id="deleteLastRcpt2" parameterType="Map" >
		delete from wcf_lastrcpt where 
			mail_user_seq = #{userSeq}
			<dynamic>
				<iterate 
					property="emails"
					prepend=" and lastrcpt_email IN "
					open="(" 
					conjunction=","
					close=")" >
					
					#{emails[]}
				</iterate>
			</dynamic>
	</delete>
	
	<delete id="deleteLastRcptSeqs" parameterType="Map" >
		delete from wcf_lastrcpt where 
			mail_user_seq = #{userSeq}
			<dynamic>
				<iterate 
					property="rcptSeqs"
					prepend=" and (rcpt_seq IN "
					open="(" 
					conjunction=","
					close=")" >
					
					#{rcptSeqs[]}
				</iterate>
			</dynamic>
			or rcpt_seq is null)
	</delete>
	
	<insert id="insertLastRcpt" parameterType="lastRcpt">
		<selectKey resultType="int" keyProperty="rcptSeq">
			select case when max(rcpt_seq) is null then 1 else max(rcpt_seq)+1 end
			from wcf_lastrcpt
		</selectKey>
		insert into wcf_lastrcpt 
				(rcpt_seq, mail_user_seq, lastrcpt_email, lastrcpt_personnel ) 
			values 
				( #{rcptSeq}, #{userSeq}, #{lastrcptEmail}, #{lastrcptPersonnel} )
	</insert>
	
	<update id="setLastLoginTime"	parameterType="map" >
		update mail_user_info 
			set 
				webmail_login_time=#{time:VARCHAR} 
			where 
				mail_user_seq = #{userSeq}
	</update>
	
	<select id="readUserInfo" parameterType="int" resultMap="userInfoResult">
		select * from mail_user_info where mail_user_seq = #{mail_user_seq}
	</select>
	
	<delete id="deleteUserInfo" parameterType="int">
		delete from mail_user_info where mail_user_seq = #{userSeq}
	</delete>
	
	<insert id="saveUserInfo" parameterType="userInfo">
		insert into mail_user_info
			<dynamic prepend=" " open="( " close=" )">
				<isNotNull property="mailUserSeq" prepend=",">
					mail_user_seq
				</isNotNull>
				<isNotNull property="ssn" prepend=",">
					ssn
				</isNotNull>
				<isNotNull property="empno" prepend=",">
					empno
				</isNotNull>
				<isNotNull property="userName" prepend=",">
					user_name
				</isNotNull>
				<isNotNull property="firstName" prepend=",">
					first_name
				</isNotNull>
				<isNotNull property="middleName" prepend=",">
					middle_name
				</isNotNull>
				<isNotNull property="lastName" prepend=",">
					last_name
				</isNotNull>
				<isNotNull property="userLanguage" prepend=",">
					user_language
				</isNotNull>
				<isNotNull property="passChgTime" prepend=",">
					pass_chg_time
				</isNotNull>
				<isNotNull property="passQuestionCode" prepend=",">
					pass_question_code
				</isNotNull>
				<isNotNull property="passQuestion" prepend=",">
					pass_question
				</isNotNull>
				<isNotNull property="passAnswer" prepend=",">
					pass_answer
				</isNotNull>
				<isNotNull property="webFolderQuota" prepend=",">
					web_folder_add_quota
				</isNotNull>
				<isNotNull property="bigAttachQuota" prepend=",">
					big_attach_add_quota
				</isNotNull>
				<isNotNull property="applyTime" prepend=",">
					apply_time
				</isNotNull>
				<isNotNull property="agreeTime" prepend=",">
					agree_time
				</isNotNull>
				<isNotNull property="deferTime" prepend=",">
					defer_time
				</isNotNull>
				<isNotNull property="registerStatus" prepend=",">
					register_status
				</isNotNull>
				<isNotNull property="lastLoginTime" prepend=",">
					last_login_time
				</isNotNull>
				<isNotNull property="webmailLoginTime" prepend=",">
					webmail_login_time
				</isNotNull>
				<isNotNull property="popLoginTime" prepend=",">
					pop_login_time
				</isNotNull>
				<isNotNull property="imapLoginTime" prepend=",">
					imap_login_time
				</isNotNull>
				<isNotNull property="mobileNo" prepend=",">
					mobile_no
				</isNotNull>
				<isNotNull property="birthday" prepend=",">
					birthday
				</isNotNull>
				<isNotNull property="homeTel" prepend=",">
					home_tel
				</isNotNull>
				<isNotNull property="homeFax" prepend=",">
					home_fax
				</isNotNull>
				<isNotNull property="homePostalCode" prepend=",">
					home_postal_code
				</isNotNull>
				<isNotNull property="homeCountry" prepend=",">
					home_country
				</isNotNull>
				<isNotNull property="homeState" prepend=",">
					home_state
				</isNotNull>
				<isNotNull property="homeCity" prepend=",">
					home_city
				</isNotNull>
				<isNotNull property="homeStreet" prepend=",">
					home_street
				</isNotNull>
				<isNotNull property="homeBasicAddress" prepend=",">
					home_basic_address
				</isNotNull>
				<isNotNull property="homeExtAddress" prepend=",">
					home_ext_address
				</isNotNull>
				<isNotNull property="privateHomepage" prepend=",">
					private_homepage
				</isNotNull>
				<isNotNull property="companyName" prepend=",">
					company_name
				</isNotNull>
				<isNotNull property="departmentName" prepend=",">
					department_name
				</isNotNull>
				<isNotNull property="officeTel" prepend=",">
					office_tel
				</isNotNull>
				<isNotNull property="officeFax" prepend=",">
					office_fax
				</isNotNull>
				<isNotNull property="officePostalCode" prepend=",">
					office_postal_code
				</isNotNull>
				<isNotNull property="officeCountry" prepend=",">
					office_country
				</isNotNull>
				<isNotNull property="officeState" prepend=",">
					office_state
				</isNotNull>
				<isNotNull property="officeCity" prepend=",">
					office_city
				</isNotNull>
				<isNotNull property="officeStreet" prepend=",">
					office_street
				</isNotNull>
				<isNotNull property="officeBasicAddress" prepend=",">
					office_basic_address
				</isNotNull>
				<isNotNull property="officeExtAddress" prepend=",">
					office_ext_address
				</isNotNull>
				<isNotNull property="classCode" prepend=",">
					class_code
				</isNotNull>
				<isNotNull property="description" prepend=",">
					description
				</isNotNull>
				<isNotNull property="creatorSeq" prepend=",">
					creator_seq
				</isNotNull>
				<isNotNull property="createTime" prepend=",">
					create_time
				</isNotNull>
				<isNotNull property="modifyTime" prepend=",">
					modify_time
				</isNotNull>
				<isNotNull property="userDN" prepend=",">
					pki_dn
				</isNotNull>
			</dynamic>
			<dynamic prepend="values " open="( " close=" )">
				<isNotNull property="mailUserSeq" prepend=",">
					#{mailUserSeq}
				</isNotNull>
				<isNotNull property="ssn" prepend=",">
					#{ssn}
				</isNotNull>
				<isNotNull property="empno" prepend=",">
					#{empno}
				</isNotNull>
				<isNotNull property="userName" prepend=",">
					#{userName}
				</isNotNull>
				<isNotNull property="firstName" prepend=",">
					#{firstName}
				</isNotNull>
				<isNotNull property="middleName" prepend=",">
					#{middleName}
				</isNotNull>
				<isNotNull property="lastName" prepend=",">
					#{lastName}
				</isNotNull>
				<isNotNull property="userLanguage" prepend=",">
					#{userLanguage}
				</isNotNull>
				<isNotNull property="passChgTime" prepend=",">
					#{passChgTime}
				</isNotNull>
				<isNotNull property="passQuestionCode" prepend=",">
					#{passQuestionCode}
				</isNotNull>
				<isNotNull property="passQuestion" prepend=",">
					#{passQuestion}
				</isNotNull>
				<isNotNull property="passAnswer" prepend=",">
					#{passAnswer}
				</isNotNull>
				<isNotNull property="webFolderQuota" prepend=",">
					#{webFolderQuota}
				</isNotNull>
				<isNotNull property="bigAttachQuota" prepend=",">
					#{bigAttachQuota}
				</isNotNull>
				<isNotNull property="applyTime" prepend=",">
					#{applyTime}
				</isNotNull>
				<isNotNull property="agreeTime" prepend=",">
					#{agreeTime}
				</isNotNull>
				<isNotNull property="deferTime" prepend=",">
					#{deferTime}
				</isNotNull>
				<isNotNull property="registerStatus" prepend=",">
					#{registerStatus}
				</isNotNull>
				<isNotNull property="lastLoginTime" prepend=",">
					#{lastLoginTime}
				</isNotNull>
				<isNotNull property="webmailLoginTime" prepend=",">
					#{webmailLoginTime}
				</isNotNull>
				<isNotNull property="popLoginTime" prepend=",">
					#{popLoginTime}
				</isNotNull>
				<isNotNull property="imapLoginTime" prepend=",">
					#{imapLoginTime}
				</isNotNull>
				<isNotNull property="mobileNo" prepend=",">
					#{mobileNo}
				</isNotNull>
				<isNotNull property="birthday" prepend=",">
					#{birthday}
				</isNotNull>
				<isNotNull property="homeTel" prepend=",">
					#{homeTel}
				</isNotNull>
				<isNotNull property="homeFax" prepend=",">
					#{homeFax}
				</isNotNull>
				<isNotNull property="homePostalCode" prepend=",">
					#{homePostalCode}
				</isNotNull>
				<isNotNull property="homeCountry" prepend=",">
					#{homeCountry}
				</isNotNull>
				<isNotNull property="homeState" prepend=",">
					#{homeState}
				</isNotNull>
				<isNotNull property="homeCity" prepend=",">
					#{homeCity}
				</isNotNull>
				<isNotNull property="homeStreet" prepend=",">
					#{homeStreet}
				</isNotNull>
				<isNotNull property="homeBasicAddress" prepend=",">
					#{homeBasicAddress}
				</isNotNull>
				<isNotNull property="homeExtAddress" prepend=",">
					#{homeExtAddress}
				</isNotNull>
				<isNotNull property="privateHomepage" prepend=",">
					#{privateHomepage}
				</isNotNull>
				<isNotNull property="companyName" prepend=",">
					#{companyName}
				</isNotNull>
				<isNotNull property="departmentName" prepend=",">
					#{departmentName}
				</isNotNull>
				<isNotNull property="officeTel" prepend=",">
					#{officeTel}
				</isNotNull>
				<isNotNull property="officeFax" prepend=",">
					#{officeFax}
				</isNotNull>
				<isNotNull property="officePostalCode" prepend=",">
					#{officePostalCode}
				</isNotNull>
				<isNotNull property="officeCountry" prepend=",">
					#{officeCountry}
				</isNotNull>
				<isNotNull property="officeState" prepend=",">
					#{officeState}
				</isNotNull>
				<isNotNull property="officeCity" prepend=",">
					#{officeCity}
				</isNotNull>
				<isNotNull property="officeStreet" prepend=",">
					#{officeStreet}
				</isNotNull>
				<isNotNull property="officeBasicAddress" prepend=",">
					#{officeBasicAddress}
				</isNotNull>
				<isNotNull property="officeExtAddress" prepend=",">
					#{officeExtAddress}
				</isNotNull>
				<isNotNull property="classCode" prepend=",">
					#{classCode}
				</isNotNull>
				<isNotNull property="description" prepend=",">
					#{description}
				</isNotNull>
				<isNotNull property="creatorSeq" prepend=",">
					#{creatorSeq}
				</isNotNull>
				<isNotNull property="createTime" prepend=",">
					#{createTime}
				</isNotNull>
				<isNotNull property="modifyTime" prepend=",">
					#{modifyTime}
				</isNotNull>
				<isNotNull property="userDN" prepend=",">
					#{userDN}
				</isNotNull>
			</dynamic>
	</insert>
	
	<update id="modifyUserInfo" parameterType="userInfo">
		update mail_user_info
			<dynamic prepend="set ">
				<isNotNull property="agreeTime" prepend=",">
					agree_time = #{agreeTime}
				</isNotNull>
				<isNotNull property="applyTime" prepend=",">
					apply_time = #{applyTime}
				</isNotNull>
				<isNotNull property="bigAttachQuota" prepend=",">
					big_attach_add_quota = #{bigAttachQuota}
				</isNotNull>
				<isNotNull property="classCode" prepend=",">
					class_code = #{classCode}
				</isNotNull>
				<isNotNull property="companyName" prepend=",">
					company_name = #{companyName}
				</isNotNull>
				<isNotNull property="createTime" prepend=",">
					create_time = #{createTime}
				</isNotNull>
				<isNotNull property="creatorSeq" prepend=",">
					creator_seq = #{creatorSeq}
				</isNotNull>
				<isNotNull property="deferTime" prepend=",">
					defer_time = #{deferTime}
				</isNotNull>
				<isNotNull property="departmentName" prepend=",">
					department_name = #{departmentName}
				</isNotNull>
				<isNotNull property="description" prepend=",">
					description = #{description}
				</isNotNull>
				<isNotNull property="empno" prepend=",">
					empno = #{empno}
				</isNotNull>
				<isNotNull property="firstName" prepend=",">
					first_name = #{firstName}
				</isNotNull>
				<isNotNull property="birthday" prepend=",">
					birthday = #{birthday}
				</isNotNull>
				<isNotNull property="homeBasicAddress" prepend=",">
					home_basic_address = #{homeBasicAddress}
				</isNotNull>
				<isNotNull property="homeCity" prepend=",">
					home_city = #{homeCity}
				</isNotNull>
				<isNotNull property="homeCountry" prepend=",">
					home_country = #{homeCountry}
				</isNotNull>
				<isNotNull property="homeExtAddress" prepend=",">
					home_ext_address = #{homeExtAddress}
				</isNotNull>
				<isNotNull property="homeFax" prepend=",">
					home_fax = #{homeFax}
				</isNotNull>
				<isNotNull property="homePostalCode" prepend=",">
					home_postal_code = #{homePostalCode}
				</isNotNull>
				<isNotNull property="homeState" prepend=",">
					home_state = #{homeState}
				</isNotNull>
				<isNotNull property="homeStreet" prepend=",">
					home_street = #{homeStreet}
				</isNotNull>
				<isNotNull property="homeTel" prepend=",">
					home_tel = #{homeTel}
				</isNotNull>
				<isNotNull property="imapLoginTime" prepend=",">
					imap_login_time = #{imapLoginTime}
				</isNotNull>
				<isNotNull property="lastLoginTime" prepend=",">
					last_login_time = #{lastLoginTime}
				</isNotNull>
				<isNotNull property="lastName" prepend=",">
					last_name = #{lastName}
				</isNotNull>
				<isNotNull property="middleName" prepend=",">
					middle_name = #{middleName}
				</isNotNull>
				<isNotNull property="mobileNo" prepend=",">
					mobile_no = #{mobileNo}
				</isNotNull>
				<isNotNull property="modifyTime" prepend=",">
					modify_time = #{modifyTime}
				</isNotNull>
				<isNotNull property="officeBasicAddress" prepend=",">
					office_basic_address = #{officeBasicAddress}
				</isNotNull>
				<isNotNull property="officeCity" prepend=",">
					office_city = #{officeCity}
				</isNotNull>
				<isNotNull property="officeCountry" prepend=",">
					office_country = #{officeCountry}
				</isNotNull>
				<isNotNull property="officeExtAddress" prepend=",">
					office_ext_address = #{officeExtAddress}
				</isNotNull>
				<isNotNull property="officeFax" prepend=",">
					office_fax = #{officeFax}
				</isNotNull>
				<isNotNull property="officePostalCode" prepend=",">
					office_postal_code = #{officePostalCode}
				</isNotNull>
				<isNotNull property="officeState" prepend=",">
					office_state = #{officeState}
				</isNotNull>
				<isNotNull property="officeStreet" prepend=",">
					office_street = #{officeStreet}
				</isNotNull>
				<isNotNull property="officeTel" prepend=",">
					office_tel = #{officeTel}
				</isNotNull>
				<isNotNull property="passAnswer" prepend=",">
					pass_answer = #{passAnswer}
				</isNotNull>
				<isNotNull property="passChgTime" prepend=",">
					pass_chg_time = #{passChgTime}
				</isNotNull>
				<isNotNull property="passQuestion" prepend=",">
					pass_question = #{passQuestion}
				</isNotNull>
				<isNotNull property="passQuestionCode" prepend=",">
					pass_question_code = #{passQuestionCode}
				</isNotNull>
				<isNotNull property="popLoginTime" prepend=",">
					pop_login_time = #{popLoginTime}
				</isNotNull>
				<isNotNull property="privateHomepage" prepend=",">
					private_homepage = #{privateHomepage}
				</isNotNull>
				<isNotNull property="registerStatus" prepend=",">
					register_status = #{registerStatus}
				</isNotNull>
				<isNotNull property="ssn" prepend=",">
					ssn = #{ssn}
				</isNotNull>
				<isNotNull property="userLanguage" prepend=",">
					user_language = #{userLanguage}
				</isNotNull>
				<isNotNull property="userName" prepend=",">
					user_name = #{userName}
				</isNotNull>
				<isNotNull property="webFolderQuota" prepend=",">
					web_folder_add_quota = #{webFolderQuota}
				</isNotNull>
				<isNotNull property="webmailLoginTime" prepend=",">
					webmail_login_time = #{webmailLoginTime}
				</isNotNull>
				<isNotNull property="userDN" prepend=",">
					pki_dn = #{userDN}
				</isNotNull>
			</dynamic>
			where
				mail_user_seq = #{mailUserSeq}
	</update>
	
	<select id="readMailUserAuthInfo" parameterType="map" resultType="HashMap">
		SELECT 
			m.mail_user_seq, m.mail_uid, m.mail_domain_seq, m.mail_group_seq, 
			m.mail_password, m.mail_host, m.message_store, m.account_expire_date, 
			m.account_status, m.user_type, m.mail_services, m.mail_add_quota, 
			m.quota_overlook_ratio, m.quota_warning_mode, m.quota_warning_ratio, m.quota_violation_action, 
			
			i.user_name, i.user_language, i.web_folder_add_quota, i.big_attach_add_quota, 
			i.last_login_time, i.webmail_login_time, i.pop_login_time, i.imap_login_time,
			i.register_status, i.last_pass_modify_time,i.create_time,
			
			d.mail_domain
		FROM 
			mail_user m, mail_user_info i, mail_domain d
		WHERE 
			m.mail_uid = #{MAIL_UID} 
			AND m.mail_domain_seq = (select mail_domain_seq from mail_domain where mail_domain = #{MAIL_DOMAIN}) 
			AND i.mail_user_seq = m.mail_user_seq
			AND d.mail_domain_seq = m.mail_domain_seq
			AND m.user_type='mailUser'
	</select>
	
	<select id="readMailUserAuthInfoByEmpno" parameterType="map" resultType="HashMap">
		SELECT 
			m.mail_user_seq, m.mail_uid, m.mail_domain_seq, m.mail_group_seq, 
			m.mail_password, m.mail_host, m.message_store, m.account_expire_date, 
			m.account_status, m.user_type, m.mail_services, m.mail_add_quota, 
			m.quota_overlook_ratio, m.quota_warning_mode, m.quota_warning_ratio, m.quota_violation_action, 
			
			i.user_name, i.user_language, i.web_folder_add_quota, i.big_attach_add_quota, 
			i.last_login_time, i.webmail_login_time, i.pop_login_time, i.imap_login_time,
			i.register_status, i.last_pass_modify_time,i.create_time,
			
			d.mail_domain
		FROM 
			mail_user m, mail_user_info i, mail_domain d
		WHERE 
			i.empno = #{EMPNO} 
			AND m.mail_domain_seq = (select mail_domain_seq from mail_domain where mail_domain = #{MAIL_DOMAIN}) 
			AND i.mail_user_seq = m.mail_user_seq
			AND d.mail_domain_seq = m.mail_domain_seq
			AND m.user_type='mailUser'
	</select>
	
	<select id="readMailUserAuthInfoByDN" parameterType="map" resultType="HashMap">
		SELECT 
			m.mail_user_seq, m.mail_uid, m.mail_domain_seq, d.mail_domain, m.mail_group_seq, 
			m.mail_password, m.mail_host, m.message_store, m.account_expire_date, 
			m.account_status, m.user_type, m.mail_services, m.mail_add_quota, 
			m.quota_overlook_ratio, m.quota_warning_mode, m.quota_warning_ratio, m.quota_violation_action, 
			
			i.user_name, i.user_language, i.web_folder_add_quota, i.big_attach_add_quota, 
			i.last_login_time, i.webmail_login_time, i.pop_login_time, i.imap_login_time,
			i.register_status, i.last_pass_modify_time,i.create_time,
			
			d.mail_domain
		FROM 
			mail_user m, mail_user_info i, mail_domain d
		WHERE 
			i.pki_dn = #{userDN}
			AND i.mail_user_seq = m.mail_user_seq
			AND m.mail_domain_seq = d.mail_domain_seq
			AND m.user_type='mailUser'
	</select>
	
	<select id="readMailUid" parameterType="int" resultType="String">
		SELECT 
			mail_uid
		FROM 
			mail_user
		WHERE 
			mail_user_seq = #{mailUserSeq}
	</select>
	
	<select id="readMailUsername" parameterType="int" resultType="String">
		SELECT 
			user_name
		FROM 
			mail_user_info
		WHERE 
			mail_user_seq = #{mailUserSeq}
	</select>
	
	<select id="readMailUserOtherInfo" parameterType="map" resultType="HashMap">
		<include refid="userAuthInfoSql" />
		WHERE 
			m.mail_user_seq = #{userSeq} 
			AND m.mail_domain_seq = #{domainSeq} 
			AND i.mail_user_seq = m.mail_user_seq
			AND e.mail_user_seq = m.mail_user_seq
			AND d.mail_domain_seq = m.mail_domain_seq
	</select>
	
	<select id="readMailUserConnectionInfo" parameterType="map" resultType="HashMap">
		<include refid="userConnectionInfoSql" />
		WHERE 
			m.mail_user_seq = #{userSeq} 
			AND m.mail_domain_seq = #{domainSeq} 
			AND i.mail_user_seq = m.mail_user_seq			
			AND d.mail_domain_seq = m.mail_domain_seq
	</select>
	
	<select id="readMailUserBySeq" parameterType="int" resultType="HashMap">
		select * 
			from 
				mail_user 
			where 
				mail_user_seq = #{mail_user_seq} 
	</select>
	
	<update id="modifyMailUser" parameterType="mailUser">
		UPDATE mail_user
		<dynamic prepend="set ">
			<isNotNull property="mailUid" prepend=",">
				mail_uid = #{mailUid}
			</isNotNull>
			<isGreaterThan property="mailDomainSeq" compareValue="0" prepend=",">
				mail_domain_seq = #{mailDomainSeq}
			</isGreaterThan>
			<isGreaterThan property="mailGroupSeq" compareValue="0" prepend=",">
				mail_group_seq = #{mailGroupSeq}
			</isGreaterThan>
			<isNotNull property="mailPassword" prepend=",">
				mail_password = #{mailPassword}
			</isNotNull>
			<isNotNull property="mailHost" prepend=",">
				mail_host = #{mailHost}
			</isNotNull>
			<isNotNull property="messageStore" prepend=",">
				message_store = #{messageStore}
			</isNotNull>
			<isNotNull property="accountExpireDate" prepend=",">
				account_expire_date = #{accountExpireDate}
			</isNotNull>
			<isNotNull property="accountStatus" prepend=",">
				account_status = #{accountStatus}
			</isNotNull>
			<isNotNull property="userType" prepend=",">
				user_type = #{userType}
			</isNotNull>
			<isGreaterThan property="mailServices" compareValue="0" prepend=",">
				mail_services = #{mailServices}
			</isGreaterThan>
			<isNotNull property="mailAddQuota" prepend=",">
				mail_add_quota = #{mailAddQuota}
			</isNotNull>
			<isNotNull property="quotaOverlookRatio" prepend=",">
				quota_overlook_ratio = #{quotaOverlookRatio}
			</isNotNull>
			<isNotNull property="quotaWarningMode" prepend=",">
				quota_warning_mode = #{quotaWarningMode}
			</isNotNull>
			<isNotNull property="quotaWarningRatio" prepend=",">
				quota_warning_ratio = #{quotaWarningRatio}
			</isNotNull>
			<isNotNull property="quotaViolationAction" prepend=",">
				quota_violation_action = #{quotaViolationAction}
			</isNotNull>
			<isNotNull property="mailMaxSendSize" prepend=",">
				mail_max_send_size = #{mailMaxSendSize}
			</isNotNull>
			<isNotNull property="inboxExpireDays" prepend=",">
				inbox_expire_days = #{inboxExpireDays}
			</isNotNull>
			<isNotNull property="sentExpireDays" prepend=",">
				sent_expire_days = #{sentExpireDays}
			</isNotNull>
			<isNotNull property="trashExpireDays" prepend=",">
				trash_expire_days = #{trashExpireDays}
			</isNotNull>
			<isNotNull property="spamExpireDays" prepend=",">
				spam_expire_days = #{spamExpireDays}
			</isNotNull>
			<isNotNull property="userExpireDays" prepend=",">
				user_expire_days = #{userExpireDays}
			</isNotNull>
			<isNotNull property="deliveryNotiType" prepend=",">
				delivery_noti_type = #{deliveryNotiType}
			</isNotNull>
			<isNotNull property="deliveryNotiMode" prepend=",">
				delivery_noti_mode = #{deliveryNotiMode}
			</isNotNull>
			<isNotNull property="forwardingMode" prepend=",">
				forwarding_mode = #{forwardingMode}
			</isNotNull>
			<isNotNull property="hiddenForwardingMode" prepend=",">
				hidden_forwarding_mode = #{hiddenForwardingMode}
			</isNotNull>
			<isNotNull property="autoReplyMode" prepend=",">
				auto_reply_mode = #{autoReplyMode}
			</isNotNull>
			<isNotNull property="autoReplyInclude" prepend=",">
				auto_reply_include = #{autoReplyInclude}
			</isNotNull>
			<isNotNull property="autoReplyStartTime" prepend=",">
				auto_reply_start_time = #{autoReplyStartTime}
			</isNotNull>
			<isNotNull property="autoReplyEndTime" prepend=",">
				auto_reply_end_time = #{autoReplyEndTime}
			</isNotNull>
			<isNotNull property="autoReplyText" prepend=",">
				auto_reply_text = #{autoReplyText}
			</isNotNull>
			<isNotNull property="autoReplySubject" prepend=",">
				auto_reply_subject = #{autoReplySubject}
			</isNotNull>
		</dynamic>
		where
			mail_user_seq = #{mailUserSeq}
	</update>

	<insert id="saveMailUser" parameterType="mailUser">
		insert into mail_user
			<dynamic prepend=" " open="( " close=" )">
				<isNotNull property="mailUid" prepend=",">
					mail_uid
				</isNotNull>
				<isGreaterThan property="mailDomainSeq" compareValue="0" prepend=",">
					mail_domain_seq
				</isGreaterThan>
				<isGreaterThan property="mailGroupSeq" compareValue="0" prepend=",">
					mail_group_seq
				</isGreaterThan>
				<isNotNull property="mailPassword" prepend=",">
					mail_password
				</isNotNull>
				<isNotNull property="mailHost" prepend=",">
					mail_host
				</isNotNull>
				<isNotNull property="messageStore" prepend=",">
					message_store
				</isNotNull>
				<isNotNull property="accountExpireDate" prepend=",">
					account_expire_date
				</isNotNull>
				<isNotNull property="accountStatus" prepend=",">
					account_status
				</isNotNull>
				<isNotNull property="userType" prepend=",">
					user_type
				</isNotNull>
				<isGreaterThan property="mailServices" compareValue="0" prepend=",">
					mail_services
				</isGreaterThan>
				<isNotNull property="mailAddQuota" prepend=",">
					mail_add_quota
				</isNotNull>
				<isNotNull property="quotaOverlookRatio" prepend=",">
					quota_overlook_ratio
				</isNotNull>
				<isNotNull property="quotaWarningMode" prepend=",">
					quota_warning_mode
				</isNotNull>
				<isNotNull property="quotaWarningRatio" prepend=",">
					quota_warning_ratio
				</isNotNull>
				<isNotNull property="quotaViolationAction" prepend=",">
					quota_violation_action
				</isNotNull>
				<isNotNull property="mailMaxSendSize" prepend=",">
					mail_max_send_size
				</isNotNull>
				<isNotNull property="inboxExpireDays" prepend=",">
					inbox_expire_days
				</isNotNull>
				<isNotNull property="sentExpireDays" prepend=",">
					sent_expire_days
				</isNotNull>
				<isNotNull property="trashExpireDays" prepend=",">
					trash_expire_days
				</isNotNull>
				<isNotNull property="spamExpireDays" prepend=",">
					spam_expire_days
				</isNotNull>
				<isNotNull property="userExpireDays" prepend=",">
					user_expire_days
				</isNotNull>
				<isNotNull property="deliveryNotiType" prepend=",">
					delivery_noti_type
				</isNotNull>
				<isNotNull property="deliveryNotiMode" prepend=",">
					delivery_noti_mode
				</isNotNull>
				<isNotNull property="forwardingMode" prepend=",">
					forwarding_mode
				</isNotNull>
				<isNotNull property="hiddenForwardingMode" prepend=",">
					hidden_forwarding_mode
				</isNotNull>
				<isNotNull property="autoReplyMode" prepend=",">
					auto_reply_mode
				</isNotNull>
				<isNotNull property="autoReplyInclude" prepend=",">
					auto_reply_include
				</isNotNull>
				<isNotNull property="autoReplyStartTime" prepend=",">
					auto_reply_start_time
				</isNotNull>
				<isNotNull property="autoReplyEndTime" prepend=",">
					auto_reply_end_time
				</isNotNull>
				<isNotNull property="autoReplyText" prepend=",">
					auto_reply_text
				</isNotNull>
				<isNotNull property="autoReplySubject" prepend=",">
					auto_reply_subject
				</isNotNull>
			</dynamic>
			<dynamic prepend="values " open="( " close=" )">
				<isNotNull property="mailUid" prepend=",">
					#{mailUid}
				</isNotNull>
				<isGreaterThan property="mailDomainSeq" compareValue="0" prepend=",">
					#{mailDomainSeq}
				</isGreaterThan>
				<isGreaterThan property="mailGroupSeq" compareValue="0" prepend=",">
					#{mailGroupSeq}
				</isGreaterThan>
				<isNotNull property="mailPassword" prepend=",">
					#{mailPassword}
				</isNotNull>
				<isNotNull property="mailHost" prepend=",">
					#{mailHost}
				</isNotNull>
				<isNotNull property="messageStore" prepend=",">
					#{messageStore}
				</isNotNull>
				<isNotNull property="accountExpireDate" prepend=",">
					#{accountExpireDate}
				</isNotNull>
				<isNotNull property="accountStatus" prepend=",">
					#{accountStatus}
				</isNotNull>
				<isNotNull property="userType" prepend=",">
					#{userType}
				</isNotNull>
				<isGreaterThan property="mailServices" compareValue="0" prepend=",">
					#{mailServices}
				</isGreaterThan>
				<isNotNull property="mailAddQuota" prepend=",">
					#{mailAddQuota}
				</isNotNull>
				<isNotNull property="quotaOverlookRatio" prepend=",">
					#{quotaOverlookRatio}
				</isNotNull>
				<isNotNull property="quotaWarningMode" prepend=",">
					#{quotaWarningMode}
				</isNotNull>
				<isNotNull property="quotaWarningRatio" prepend=",">
					#{quotaWarningRatio}
				</isNotNull>
				<isNotNull property="quotaViolationAction" prepend=",">
					#{quotaViolationAction}
				</isNotNull>
				<isNotNull property="mailMaxSendSize" prepend=",">
					#{mailMaxSendSize}
				</isNotNull>
				<isNotNull property="inboxExpireDays" prepend=",">
					#{inboxExpireDays}
				</isNotNull>
				<isNotNull property="sentExpireDays" prepend=",">
					#{sentExpireDays}
				</isNotNull>
				<isNotNull property="trashExpireDays" prepend=",">
					#{trashExpireDays}
				</isNotNull>
				<isNotNull property="spamExpireDays" prepend=",">
					#{spamExpireDays}
				</isNotNull>
				<isNotNull property="userExpireDays" prepend=",">
					#{userExpireDays}
				</isNotNull>
				<isNotNull property="deliveryNotiType" prepend=",">
					#{deliveryNotiType}
				</isNotNull>
				<isNotNull property="deliveryNotiMode" prepend=",">
					#{deliveryNotiMode}
				</isNotNull>
				<isNotNull property="forwardingMode" prepend=",">
					#{forwardingMode}
				</isNotNull>
				<isNotNull property="hiddenForwardingMode" prepend=",">
					#{hiddenForwardingMode}
				</isNotNull>
				<isNotNull property="autoReplyMode" prepend=",">
					#{autoReplyMode}
				</isNotNull>
				<isNotNull property="autoReplyInclude" prepend=",">
					#{autoReplyInclude}
				</isNotNull>
				<isNotNull property="autoReplyStartTime" prepend=",">
					#{autoReplyStartTime}
				</isNotNull>
				<isNotNull property="autoReplyEndTime" prepend=",">
					#{autoReplyEndTime}
				</isNotNull>
				<isNotNull property="autoReplyText" prepend=",">
					#{autoReplyText}
				</isNotNull>
				<isNotNull property="autoReplySubject" prepend=",">
					#{autoReplySubject}
				</isNotNull>
			</dynamic>
	</insert>
	
	<delete id="deleteMailUser" parameterType="int">
		DELETE FROM mail_user where mail_user_seq = #{mail_user_seq}
	</delete>
	
	<select id="readMailUserInfo" parameterType="int"	resultMap="userInfoResult">
		select * from mail_user_info where mail_user_seq = #{mail_user_seq}	
	</select>
	
	<select id="readMailUserInfoByUid" parameterType="Map" resultMap="userInfoResult">
		select c.* 
		from 
			mail_domain a, mail_user b, mail_user_info c
		where 
			a.mail_domain_seq = b.mail_domain_seq 
			and b.mail_user_seq = c.mail_user_seq
			and a.mail_domain_seq = #{domainSeq}
			and b.mail_uid =  #{userId}
	</select>
	
	<select id="readMailUserInfoByEmail" parameterType="Map" resultMap="userInfoResult">
		select c.* 
		from 
			mail_domain a, mail_user b, mail_user_info c
		where 
			a.mail_domain_seq = b.mail_domain_seq 
			and b.mail_user_seq = c.mail_user_seq
			and a.mail_domain = #{mailDomain}
			and b.mail_uid =  #{userId}
	</select>
	
	<select id="readMailuserSsoInfoByUid" parameterType="map" resultType="String">
		select 
			a.mail_uid from mail_user a, mail_domain b 
		where
			a.mail_domain_seq = b.mail_domain_seq
			and b.mail_domain=#{domain} 
			and mail_uid = #{mailUid}
	</select>
	
	<select id="readMailuserSsoInfoByEmpno" parameterType="map" resultType="String">
		select 
			a.mail_uid from mail_user a, mail_domain b, mail_user_info c 
		where
			a.mail_domain_seq = b.mail_domain_seq
			and a.mail_user_seq=c.mail_user_seq
			and b.mail_domain=#{domain} 
			and c.empno = #{empno}
	</select>
	
	<select id="readMailuserSsoInfoBySsn" parameterType="map" resultType="String">
		select 
			a.mail_uid from mail_user a, mail_domain b, mail_user_info c 
		where
			a.mail_domain_seq = b.mail_domain_seq
			and a.mail_user_seq=c.mail_user_seq
			and b.mail_domain=#{domain} 
			and ssn = #{ssn}
	</select>
	
	<select id="readUserInfoByUid" parameterType="int" resultType="HashMap">
		select u.mail_uid, d.mail_domain 
		from mail_user u, mail_domain d
		where u.mail_domain_seq = d.mail_domain_seq
		and u.mail_user_seq = #{userSeq}
	</select>
	
	<sql id="getEmail_Where_Clause" >
		and (   		
   		<isEqual property="keyWord" compareValue="ㄱ">
   		<![CDATA[
   		substr(member_name,1,1) >= '가' and substr(member_name,1,1) < '나' or
   		]]>
   		</isEqual>
   		
   		<isEqual property="keyWord" compareValue="ㄴ">
   		<![CDATA[
   		substr(member_name,1,1) >= '나' and substr(member_name,1,1) < '다' or
   		]]>
   		</isEqual>
   		
   		<isEqual property="keyWord" compareValue="ㄷ">
   		<![CDATA[
   		substr(member_name,1,1) >= '다' and substr(member_name,1,1) < '라' or
   		]]>
   		</isEqual>
   		
   		<isEqual property="keyWord" compareValue="ㄹ">
   		<![CDATA[
   		substr(member_name,1,1) >= '라' and substr(member_name,1,1) < '마' or
   		]]>
   		</isEqual>
   		
   		<isEqual property="keyWord" compareValue="ㅁ">
   		<![CDATA[
   		substr(member_name,1,1) >= '마' and substr(member_name,1,1) < '바' or
   		]]>
   		</isEqual>
   		
   		<isEqual property="keyWord" compareValue="ㅂ">
   		<![CDATA[
   		substr(member_name,1,1) >= '바' and substr(member_name,1,1) < '사' or
   		]]>
   		</isEqual>
   		
   		<isEqual property="keyWord" compareValue="ㅅ">
   		<![CDATA[
   		substr(member_name,1,1) >= '사' and substr(member_name,1,1) < '아' or
   		]]>
   		</isEqual>
   		
   		<isEqual property="keyWord" compareValue="ㅇ">
   		<![CDATA[
   		substr(member_name,1,1) >= '아' and substr(member_name,1,1) < '자' or
   		]]>
   		</isEqual>
   		
   		<isEqual property="keyWord" compareValue="ㅈ">
   		<![CDATA[
   		substr(member_name,1,1) >= '자' and substr(member_name,1,1) < '차' or
   		]]>
   		</isEqual>
   		
   		<isEqual property="keyWord" compareValue="ㅊ">
   		<![CDATA[
   		substr(member_name,1,1) >= '차' and substr(member_name,1,1) < '카' or
   		]]>
   		</isEqual>
   		
   		<isEqual property="keyWord" compareValue="ㅋ">
   		<![CDATA[
   		substr(member_name,1,1) >= '카' and substr(member_name,1,1) < '타'or
   		]]>
   		</isEqual>
   		
   		<isEqual property="keyWord" compareValue="ㅌ">
   		<![CDATA[
   		substr(member_name,1,1) >= '타' and substr(member_name,1,1) < '파' or
   		]]>
   		</isEqual>
   		
   		<isEqual property="keyWord" compareValue="ㅍ">
   		<![CDATA[
   		substr(member_name,1,1) >= '파' and substr(member_name,1,1) < '하' or
   		]]>
   		</isEqual>
   		
   		<isEqual property="keyWord" compareValue="ㅎ">
   		<![CDATA[
   		substr(member_name,1,1) >= '하' and substr(member_name,1,1) < '힝' or
   		]]>
   		</isEqual>
   		
   		<isGreaterThan property="keyWord" compareValue="ㅎ">
   			member_name like '${keyWord}%' or
   		</isGreaterThan>
   		
   		<isLessThan property="keyWord" compareValue="ㄱ">
   			member_name like '${keyWord}%' or
   		</isLessThan>
	</sql>
	
	<select id="readPrivateAddrAddressList" parameterType="Map" resultType="address" cacheModel="privateAddressCache">
		SELECT  zz.name,zz.email
		FROM(
			SELECT
		      a.member_name as name, a.member_email as email
		    FROM adr_private_member a
		    WHERE 
		    	a.mail_user_seq=#{userSeq}
		    	and (a.delete_flag IS NULL or a.delete_flag != 'Y')
		    	<dynamic>
					<isParameterPresent >
						<isEqual property="staticParam" compareValue="T">
				      		<include refid="getEmail_Where_Clause" />
					   		member_email like '${keyWord}%')
				      	</isEqual>
				      	<isEqual property="staticParam" compareValue="F">
				      		<isNotEmpty property="keyWord">
				      			and member_name = #{keyWord}
				      		</isNotEmpty>
				      	</isEqual>
				    </isParameterPresent>
				</dynamic>
			<isNotEmpty property="keyWord">		
		    limit 0, 15
		    </isNotEmpty>
		    ) zz
		  LEFT JOIN(
			  SELECT mail_uid as name,CONCAT(mail_uid,CONCAT('@',b.mail_domain)) as email
	          FROM mail_user a,  mail_domain b
	          where a.mail_domain_seq = b.mail_domain_seq
	          	and a.mail_domain_seq = #{mailDomain} 
	          	and a.account_status = 'disabled'
		   ) gg ON zz.email = gg.email
		   WHERE gg.email is null;
	</select>
	
	<select id="readSharedAddrAddressList" parameterType="Map" resultType="address" cacheModel="sharedAddressCache">
		SELECT  zz.name,zz.email
		FROM(
			SELECT
		      b.member_name as name, b.member_email as email
		    FROM adr_shared_master a, adr_shared_member b
		    WHERE
		    	a.mail_domain_seq=#{mailDomain}
		    	and a.adrbook_seq=b.adrbook_seq
		    	and b.adrbook_seq in 
		    	(
		    		select adrbook_seq from adr_shared_reader where mail_user_seq=#{userSeq}
		    		union 
		    		select adrbook_seq from adr_shared_moderator where mail_user_seq=#{userSeq}
		    		union 
		    		select adrbook_seq from adr_shared_master where creator_seq = #{userSeq} or reader_type='A'
		    	)
		    	<dynamic>
					<isParameterPresent >
				      <isEqual property="staticParam" compareValue="T">
				      		<include refid="getEmail_Where_Clause" />
					   		member_email like '${keyWord}%')
				      	</isEqual>
				      	<isEqual property="staticParam" compareValue="F">
				      		<isNotEmpty property="keyWord">
				      			and member_name = #{keyWord}
				      		</isNotEmpty>
				      	</isEqual>
				    </isParameterPresent>
				</dynamic>
		    <isNotEmpty property="keyWord">		
		    limit 0, 15
		    </isNotEmpty>
		  ) zz
		  LEFT JOIN(
			  SELECT mail_uid as name,CONCAT(mail_uid,CONCAT('@',b.mail_domain)) as email
	          FROM mail_user a,  mail_domain b
	          where a.mail_domain_seq = b.mail_domain_seq
	          	and a.mail_domain_seq = #{mailDomain} 
	          	and a.account_status = 'disabled'
		   ) gg ON zz.email = gg.email
		   WHERE gg.email is null;
	</select>
	
	<select id="readDeptAddressList" parameterType="Map" resultType="address" cacheModel="orgCache">
		select
			org_name as name, 
			org_code as deptCode 
		from 
			torg_organization 
		where 
			mail_domain_seq=#{mailDomain} 
			and org_name like #{deptName}
		
		union
		
		select
			org_name_en as name, 
			org_code as deptCode 
		from 
			torg_organization 
		where 
			mail_domain_seq=#{mailDomain} 
			and org_name_en like #{deptName}  
			
		union
		
		select
			org_name_jp as name, 
			org_code as deptCode 
		from 
			torg_organization 
		where 
			mail_domain_seq=#{mailDomain} 
			and org_name_jp like #{deptName}
	</select>
	
	<select id="readDeptFullCodeList" parameterType="Map" resultType="address" cacheModel="orgCache">
		select
			org_name as name, 
			org_fullcode as deptCode 
		from 
			torg_organization 
		where 
			mail_domain_seq=#{mailDomain}
			and org_name like #{deptName}
			
		union 
		
		select
			org_name_en as name, 
			org_fullcode as deptCode 
		from 
			torg_organization 
		where 
			mail_domain_seq=#{mailDomain}
			and org_name_en like #{deptName}
		
		union 
		
		select
			org_name_jp as name, 
			org_fullcode as deptCode 
		from 
			torg_organization 
		where 
			mail_domain_seq=#{mailDomain}
			and org_name_jp like #{deptName}
			
	</select>
	
	<select id="getDeptMap" resultMap="groupConfigResult" parameterType="int" cacheModel="orgCache">
    	select 
    		ORG_CODE as config_name, ORG_NAME as config_value
    	from TORG_ORGANIZATION
    	where 
    		MAIL_DOMAIN_SEQ = #{mailDomainSeq}
	</select>
	
	<select id="readDomainAddressList" parameterType="Map" resultType="address">
		select 
			c.member_name as name,
			CONCAT(b.mail_uid, CONCAT('@',  d.mail_domain)) as email,
			c.company_name as deptName,
			c.department_name as title
		from mail_user b, mail_domain d,
			(select mail_user_seq, user_name as member_name, company_name, department_name from mail_user_info where register_status = 'agree') c
		where 
	    	b.mail_user_seq=c.mail_user_seq
	    	and b.mail_domain_seq = d.mail_domain_seq
			and d.mail_domain_seq=#{mailDomain}
			and b.mail_uid not in ('tims_bbs_storage_user', 'tims_webfolder_storage_user')
			and b.account_status != 'disabled'
			<dynamic>
				<isParameterPresent >
			      <isEqual property="staticParam" compareValue="T">
			      		<include refid="getEmail_Where_Clause" />			      		
				   		mail_uid like '${keyWord}%')				   		
			      	</isEqual>
			      	<isEqual property="staticParam" compareValue="F">
			      		<isNotEmpty property="keyWord">
			      			and member_name = #{keyWord}
			      		</isNotEmpty>
			      	</isEqual>
			    </isParameterPresent>
			</dynamic>
	    <isNotEmpty property="keyWord">		
	    limit 0, 15
	    </isNotEmpty>
	</select>
	
	<select id="readOrgAddressList" parameterType="Map" resultType="address" cacheModel="orgCache">
		select 
			c.member_name as name,
			e.org_name as deptName,
    		(
    			select cc.code_name from tdomain_code cc, tdomain_code_class dd 
    			where 
    				cc.mail_domain_seq=dd.mail_domain_seq 	
    				and cc.code_class=dd.code_class 
    				and cc.code_class='101'
    				and cc.code_locale=#{locale} 
    				and cc.mail_domain_seq=#{mailDomain} 
    				and cc.code= a.title_code
    			limit 0, 1
    		) as title ,
			CONCAT(b.mail_uid, CONCAT('@',  d.mail_domain)) as email 
		from TORG_MEMBER a, mail_user b, mail_domain d, TORG_ORGANIZATION e,
			(select mail_user_seq, user_name as member_name from mail_user_info ) c
		where 
	    	a.mail_user_seq=b.mail_user_seq
	    	and b.mail_user_seq=c.mail_user_seq
	    	and a.org_code=e.org_code
	    	and b.mail_domain_seq = d.mail_domain_seq
			and a.MAIL_DOMAIN_SEQ = #{mailDomain}
			and b.account_status != 'disabled'
			<dynamic>
				<isParameterPresent >
			      <isEqual property="staticParam" compareValue="T">
			      		<include refid="getEmail_Where_Clause" />
			      		b.mail_uid like '${keyWord}%')
			      	</isEqual>
			      	<isEqual property="staticParam" compareValue="F">
			      		<isNotEmpty property="keyWord">
			      			and member_name = #{keyWord}
			      		</isNotEmpty>
			      	</isEqual>
			    </isParameterPresent>
			</dynamic>
	    <isNotEmpty property="keyWord">		
	    limit 0, 15
	    </isNotEmpty>
	</select>
	
	<select id="readUserAddressList" parameterType="Map" resultType="address">
		SELECT
	      a.member_name as name, a.member_email as email
	    FROM adr_private_member a
	    WHERE a.mail_user_seq=#{userSeq}
	    
	    union
	    
	    SELECT
	      b.member_name as name, b.member_email as email
	    FROM adr_shared_member b
	    WHERE
	    	b.adrbook_seq in 
	    	(
	    		select adrbook_seq from adr_shared_reader where mail_user_seq=#{userSeq}
	    		union 
	    		select adrbook_seq from adr_shared_moderator where mail_user_seq=#{userSeq}
	    		union 
	    		select adrbook_seq from adr_shared_master where creator_seq = #{userSeq} or reader_type='A'
	    	)
	    	
	    union
	    
	    select 
			c.user_name as name, 
			CONCAT(b.mail_uid, CONCAT('@',  d.mail_domain)) as email
		from TORG_MEMBER a, mail_user b, mail_user_info c, mail_domain d
		where 
	    	a.mail_user_seq=b.mail_user_seq
	    	and b.mail_user_seq=c.mail_user_seq
	    	and b.mail_domain_seq = d.mail_domain_seq
			and a.MAIL_DOMAIN_SEQ = #{mailDomain}
	</select>
	
	<select id="readRecentRcptAddressList" parameterType="Map" resultType="address" cacheModel="lastRcptCache">
	SELECT  zz.name,zz.email
	FROM(
		select 
			a.member_name as name, a.lastrcpt_email as email
		from 
			(select mail_user_seq, lastrcpt_email, lastrcpt_personnel as member_name  from wcf_lastrcpt where mail_user_seq = #{userSeq}) a
		where 
			a.mail_user_seq = #{userSeq}
			<dynamic>
				<isParameterPresent >
			      <isEqual property="staticParam" compareValue="T">
			      		<include refid="getEmail_Where_Clause" />
			      		lastrcpt_email like '${keyWord}%')				   		
			      	</isEqual>
			      	<isEqual property="staticParam" compareValue="F">
			      		<isNotEmpty property="keyWord">
			      			and member_name = #{keyWord}
			      		</isNotEmpty>
			      	</isEqual>
			    </isParameterPresent>
			</dynamic>
		<isNotEmpty property="keyWord">		
	    limit 0, 15
	    </isNotEmpty>
	   ) zz
	  LEFT JOIN(
		  SELECT mail_uid as name,CONCAT(mail_uid,CONCAT('@',b.mail_domain)) as email
          FROM mail_user a,  mail_domain b
          where a.mail_domain_seq = b.mail_domain_seq
          	and a.mail_domain_seq = #{mailDomain} 
          	and a.account_status = 'disabled'
	   ) gg ON zz.email = gg.email
	   WHERE gg.email is null;
	</select>
	
	<select id="readWebfolderInfo" parameterType="int" resultMap="webfolderInfoResult">
		select m.mail_domain_seq, m.mail_user_seq, m.mail_uid, m.mail_host, m.message_store, d.mail_domain, g.web_folder_quota, i.web_folder_add_quota
		from mail_user m, mail_user_info i, mail_domain d, mail_domain_group g 
		where m.mail_user_seq = i.mail_user_seq 
		and m.mail_domain_seq = d.mail_domain_seq 
		and m.mail_domain_seq = g.mail_domain_seq
		and m.mail_group_seq = g.mail_group_seq
		and m.mail_user_seq = #{userSeq}
	</select>
	
	<select id="readBbsInfo" parameterType="int" resultMap="bbsInfoResult">
		select m.mail_domain_seq, m.mail_user_seq, m.mail_uid, m.mail_host, m.message_store, 
				d.mail_domain, g.mail_quota, m.mail_add_quota, m.quota_warning_mode, 
				m.quota_warning_ratio, m.quota_overlook_ratio
		from mail_user m, mail_user_info i, mail_domain d, mail_domain_group g
		where m.mail_user_seq = i.mail_user_seq
		and m.mail_domain_seq = d.mail_domain_seq
		and m.mail_domain_seq = g.mail_domain_seq
		and m.mail_group_seq = g.mail_group_seq
		and m.mail_user_seq = #{userSeq}
	</select>
	
	<select id="readUserPass" parameterType="int" resultType="String">
		SELECT mail_password FROM mail_user where mail_user_seq = #{value}
	</select>
	
	<select id="readUserInfoBySsn" parameterType="Map" resultType="int">
		select count(ssn) 
		from 
			mail_domain a, mail_user b, mail_user_info c 
		where
			a.mail_domain_seq = b.mail_domain_seq
			and b.mail_user_seq = c.mail_user_seq
			and c.ssn=#{ssn}
			and a.mail_domain=#{domain}
	</select>
	
	<select id="readUserInfoByEmpno" parameterType="Map" resultType="int">
		select count(empno) 
		from 
			mail_domain a, mail_user b, mail_user_info c 
		where
			a.mail_domain_seq = b.mail_domain_seq
			and b.mail_user_seq = c.mail_user_seq
			and c.empno=#{empno}
			and a.mail_domain=#{domain}
	</select>
	
	<select id="readUserIdDupCheck" parameterType="map" resultType="int">
		select count(*) from mail_user m left outer join mail_user_alternate a
		on m.mail_user_seq = a.mail_user_seq
		where m.mail_domain_seq = #{mailDomainSeq}
		and (mail_uid = #{userId} || alternate_uid = #{userId})
	</select>
	
	<select id="readUserSeq" parameterType="map" resultType="int">
		select mail_user_seq from mail_user where mail_domain_seq=#{mailDomainSeq} and mail_uid=#{userId}
	</select>
	
	<select id="readUserSeq2" parameterType="map" resultType="int">
		select b.mail_user_seq 
		from 
			mail_domain a, mail_user b 
		where
			a.mail_domain_seq = b.mail_domain_seq
			and a.mail_domain=#{mailDomain}
			and b.mail_uid=#{userId}
	</select>
	
	<select id="searchUserId" parameterType="map" resultType="String">
		select mail_uid from mail_user m, mail_user_info i where
		m.mail_user_seq = i.mail_user_seq
		and m.mail_domain_seq = #{mailDomainSeq}
		and i.user_name = #{userName}
		and i.ssn = #{ssn}
	</select>
	
	<select id="searchUserIdByEmpno" parameterType="map" resultType="String">
		select mail_uid from mail_user m, mail_user_info i where
		m.mail_user_seq = i.mail_user_seq
		and m.mail_domain_seq = #{mailDomainSeq}
		and i.user_name = #{userName}
		and i.empno = #{empno}
	</select>
	
	<select id="searchUserIdByJpInfo" parameterType="map" resultType="String">
		select mail_uid from mail_user m, mail_user_info i 
		where m.mail_user_seq = i.mail_user_seq
		and m.mail_domain_seq = #{mailDomainSeq}
		and i.user_name = #{userName}
		and i.home_postal_code = #{postalCode}
		and i.birthday = #{birthday}
	</select>

	<select id="searchMailUser" parameterType="map" resultMap="userListResult">
		select m.mail_uid, d.mail_domain, i.user_name, m.mail_domain_seq, m.mail_user_seq 
		from mail_user m, mail_domain d, mail_user_info i 
		where			
			m.mail_domain_seq = #{mailDomainSeq}
			and m.mail_domain_seq = d.mail_domain_seq
			and m.mail_user_seq = i.mail_user_seq
			and m.mail_uid not in ('tims_bbs_storage_user', 'tims_webfolder_storage_user')
			and m.user_type not in ('aliasUser')	
			<dynamic prepend="">
				<isNotEmpty prepend="and" property="userId">
					m.mail_uid like '%${userId}%'
				</isNotEmpty>
				<isNotEmpty prepend="and" property="userName">
					i.user_name like '%${userName}%'
				</isNotEmpty>
			</dynamic>		
	</select>
	
	<select id="searchMailUser2" parameterType="map" resultMap="userListResult">
		select m.mail_uid, d.mail_domain, i.user_name, m.mail_domain_seq, m.mail_user_seq 
		from mail_user m, mail_domain d, mail_user_info i 		
		where			
			m.mail_domain_seq = #{mailDomainSeq}
			and m.mail_domain_seq = d.mail_domain_seq
			and m.mail_user_seq = i.mail_user_seq		
			and m.user_type not in ('aliasUser')
			<dynamic prepend="">
				<isNotEmpty prepend="and" property="userId">
					m.mail_uid = #{userId}
				</isNotEmpty>
				<isNotEmpty prepend="and" property="userName">
					i.user_name = #{userName}
				</isNotEmpty>
			</dynamic>		
	</select>
	
	<select id="searchPassword" parameterType="map" resultType="int">
		select m.mail_user_seq from mail_user m, mail_user_info i
		where m.mail_user_seq = i.mail_user_seq
		and m.mail_domain_seq = #{mailDomainSeq}
		and m.mail_uid = #{userId}
		and i.pass_question_code = #{passCode}
		and i.pass_answer = #{passAnswer}
	</select>
	
	<update id="changeUserPassword" parameterType="map">
		update mail_user
		<dynamic prepend="set ">
			<isNotNull property="mailPassword" prepend=",">
				mail_password = #{mailPassword}
			</isNotNull>
			where mail_user_seq = #{mailUserSeq}
		</dynamic>
	</update>
	
	<update id="changeUserAccount" parameterType="map">
		update mail_user set account_status = #{status} where mail_user_seq = #{mailUserSeq}
	</update>
	
	<select id="readUserFolderAging" parameterType="int" resultMap="agingMapResult">
		select folder_name, aging_day
		from mail_userfolder_aging where	mail_user_seq = #{value}		
	</select>
	
	<insert id="insertFolderAging" parameterType="map">
		insert into mail_userfolder_aging (mail_user_seq, folder_name, aging_day)
		values (#{mailUserSeq},#{folderName},#{agingDay})
	</insert>
	
	<update id="changeFolderAging" parameterType="map">
		update mail_userfolder_aging set
		aging_day = #{agingDay}
		where mail_user_seq = #{mailUserSeq}	
		and folder_name = #{folderName}
	</update>
	
	<update id="changeFolderName" parameterType="map">
		update mail_userfolder_aging set
		folder_name = #{changeFolderName}
		where mail_user_seq = #{mailUserSeq}	
		and folder_name = #{folderName}
	</update>
	
	<delete id="deleteFolderAging" parameterType="map">
		delete from mail_userfolder_aging		
		where mail_user_seq = #{mailUserSeq} 
		and folder_name = #{folderName}		
	</delete>
	
	<select id="readUserPassFailCount" parameterType="int" resultType="int">
		select 
			
			case when wrong_pass_count is null then 0 else wrong_pass_count end as count
		from mail_user_info where	mail_user_seq = #{value}		
	</select>
	
	<update id="updateUserPassFailCount" parameterType="map" >
		update mail_user_info 
			set 
				wrong_pass_count=#{count} 
			where 
				mail_user_seq = #{userSeq}
	</update>
	
	<update id="updateLoginInfo" parameterType="map" >
		update mail_user_info 
			set 
				webmail_login_time=#{loginInfo} 
			where 
				mail_user_seq = #{userSeq}
	</update>
	
	<select id="readUserIdByAlternate" parameterType="map" resultType="String">
		select m.mail_uid
		from mail_user m, mail_user_alternate a, mail_domain d 
		where a.alternate_uid = #{uid} 
			and a.mail_user_seq = m.mail_user_seq
			and m.mail_domain_seq = d.mail_domain_seq
			and d.mail_domain =  #{domain} 		
	</select>
	
	<select id="readMassSend" parameterType="int" resultType="String">
		select mass_send from mail_user_info where mail_user_seq = #{mail_user_seq}
	</select>
	
	<select id="readUserDN" parameterType="int" resultType="String">
		select pki_dn from mail_user_info where mail_user_seq = #{mail_user_seq}
	</select>
	
	<select id="readAccountDN" parameterType="map" resultType="String">
		select pki_dn 
		from mail_user_info i, mail_user m, mail_domain d  
		where m.mail_uid = #{uid}
			and d.mail_domain =  #{domain} 
			and i.mail_user_seq = m.mail_user_seq
			and m.mail_domain_seq = d.mail_domain_seq			  
	</select>
	
	<select id="getUserSetting" resultMap="groupConfigResult" parameterType="Map">
    	select
			config_name, attr_value as config_value
		from mail_config_file   
		where 
			config_name = 'encrypt'
			and attr_name='encrypt'
			
		union all
			
		select
			'sign_apply' as config_name ,sign_apply as config_value
		from wcf_sign
		where 
			mail_user_seq =  #{userSeq}
			
		union all 
			
		select
			'sign_location' as config_name ,sign_location as config_value
		from wcf_sign
		where 
			mail_user_seq =  #{userSeq}
			
		union all
		
		select
			config_name, config_value
  		from mail_config  
 		where config_name = 'securemail' 
 		
 		union all
 		
 		select
			attr_name as config_name, attr_value as config_value 
  		from mail_config_file    
 		where      
 			config_name = 'im4/im4reserve'
   			and attr_name = 'reserve_limit' 
   			
   		union all
   		
   		select
			config_name, config_value
  		from mail_domain_config    
 		where 
 			mail_domain_seq =  #{domainSeq} /**P*/   
   			and (config_name = 'rcpt_mode' or config_name = 'send_check')   
   			
   		union all
   		
   		select
			'mass_send' as config_name , mass_send as config_value
  		from mail_user_info
 		where mail_user_seq =  #{userSeq}
 		
 		union all
 		
 		select
			config_name, config_value
  		from mail_config  
 		where config_name 
 			in    (      'bigattach_expireday'     
			,   'bigattach_download'     
			,   'bigattach_maxsize'
			,	'bigattach_download_limited'     
			,   'attach_maxsize'     )
			
		union all
		
		select 
    		'file_size' as config_name, 
			case when sum(FILE_SIZE) is null then 0 else sum(FILE_SIZE) end as config_value 
    	from MAIL_BIG_ATTACH
    	where 
      		MAIL_USER_SEQ = #{userSeq} AND ATTACH_FLAG != 'del'
      		
      	union all
      	
      	select 
      		'sign_apply' as config_name, 
      		sign_apply 
      	from 
      		wcf_sign where mail_user_seq = #{userSeq}
      		
      	union all
      	
      	select 
      		'sign_location' as config_name, 
      		sign_location 
      	from 
      		wcf_sign where mail_user_seq = #{userSeq}
      		
      	union all
      	
      	select 
      		'doc_template_use' as config_name, 
      		doc_template_use 
      	from 
      		mail_domain_group where mail_domain_seq =  #{domainSeq} and mail_group_seq =  #{groupSeq} 
	</select>
	<select id="readUserInfoByJpInfo" parameterType="map" resultType="int">
		select count(*) from mail_domain a, mail_user b, mail_user_info c 
		where
			a.mail_domain_seq = b.mail_domain_seq
			and a.mail_domain = #{domain}
			and b.mail_user_seq = c.mail_user_seq
			and c.user_name = #{name}
			and c.home_postal_code = #{postalCode}
			and c.birthday = #{birthday}
	</select>
	
	<select id="readUserIdAndName" parameterType="int" resultMap="searchUserResult">
		select * from mail_user u, mail_user_info i
		where u.mail_user_seq = #{mailUserSeq}
		and u.mail_user_seq = i.mail_user_seq
	</select>
	
	<select id="readUserInfoMobileNo" parameterType="int" resultType="String">
		select mobile_no from mail_user_info where mail_user_seq = #{mailUserSeq}
	</select>
	
	<select id="readMailUids" parameterType="int" resultType="String">
		select mail_uid from mail_user where mail_domain_seq = #{mailDomainSeq}
		and mail_uid not in ('tims_bbs_storage_user', 'tims_webfolder_storage_user', 'hamadm', 'spamadm')
		and user_type != 'orgAdmin'
		and user_type not in ('aliasUser')
	</select>
	
	<select id="readRcptSearchOption" parameterType="int" resultType="String" cacheModel="searchRcptOption">
		select config_value from mail_domain_config where mail_domain_seq = #{mailDomainSeq} and config_name='search_rcpt'
	</select>
	
	<select id="readMassSenderUser" parameterType="int" resultType="String">
		select config_value from mail_domain_config where mail_domain_seq = #{mailDomainSeq} and config_name='mass_sender_user'
	</select>
	
	<select id="readFileUploadUser" parameterType="int" resultType="String">
		select config_value from mail_domain_config where mail_domain_seq = #{mailDomainSeq} and config_name='mass_file_upload_user'
	</select>
	
	<select id="readMassUpload" parameterType="int" resultType="String">
		select mass_upload from mail_user_info where mail_user_seq = #{mail_user_seq}
	</select>
	
	<select id="readNoteSaveCount" parameterType="map" resultType="int">
		select ifnull(sum(note_save_count), 0) from (
			select note_save_count from mail_domain_group where mail_domain_seq = #{mailDomainSeq} and mail_group_seq = #{mailGroupSeq}
			union all
			select note_save_count from mail_user_info where mail_user_seq = #{mailUserSeq}
		)a
	</select>
	
	<select id="readNoteSaveDate" parameterType="map" resultType="int">
		select ifnull(sum(note_expire_days), 0) from (
			select note_expire_days from mail_domain_group where mail_domain_seq = #{mailDomainSeq} and mail_group_seq = #{mailGroupSeq}
			union all
			select note_expire_days from mail_user_info where mail_user_seq = #{mailUserSeq}
		)a
	</select>
	<select id="readMailUserConfig" parameterType="map" resultType="String">
        select config_value from mail_user_config where mail_user_seq = #{mailUserSeq} and config_name = #{configName}
    </select>
    <insert id="saveMailUserConfig" parameterType="map">
        insert into mail_user_config 
            (mail_user_seq, config_name, config_value) 
        values
            (#{mailUserSeq}, #{configName}, #{configValue})
    </insert>
    <delete id="deleteMailUserConfig" parameterType="map">
        delete from mail_user_config where mail_user_seq = #{mailUserSeq} and config_name = #{configName}
    </delete>
</mapper>